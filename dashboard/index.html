<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EpochQ Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --border: #2a2d3e;
      --accent: #6c63ff;
      --accent2: #00d9a3;
      --text: #e2e4ef;
      --muted: #6b7280;
      --danger: #ff4c6a;
      --warn: #f59e0b;
      --ok: #10b981;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* ── Topbar ──────────────────────────── */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 17px; }
    .logo svg { flex-shrink: 0; }

    .status-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; border-radius: 999px;
      font-size: 12px; font-weight: 600;
      background: rgba(16,185,129,.15); color: var(--ok);
    }
    .status-pill.error { background: rgba(255,76,106,.15); color: var(--danger); }
    .status-pill .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: currentColor; animation: pulse 1.6s infinite;
    }
    @keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:.4 } }

    /* ── Layout ──────────────────────────── */
    main { padding: 24px; max-width: 1280px; margin: 0 auto; }

    /* ── Stat cards ──────────────────────── */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 20px;
    }
    .card-label { font-size: 11px; font-weight: 600; letter-spacing: .07em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .card-value { font-size: 28px; font-weight: 700; line-height: 1; }
    .card-value.accent  { color: var(--accent2); }
    .card-value.warn    { color: var(--warn); }
    .card-value.danger  { color: var(--danger); }
    .card-value.neutral { color: var(--text); }

    /* ── Section heading ─────────────────── */
    .section-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .section-head h2 { font-size: 15px; font-weight: 600; }
    .refresh-info { font-size: 12px; color: var(--muted); }

    /* ── Table ───────────────────────────── */
    .table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border); }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: var(--surface);
      padding: 10px 14px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .07em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }
    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .1s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(108,99,255,.06); }
    tbody td { padding: 11px 14px; }

    .badge {
      display: inline-block;
      padding: 2px 8px; border-radius: 999px;
      font-size: 11px; font-weight: 600;
    }
    .badge-ready    { background: rgba(0,217,163,.15); color: var(--accent2); }
    .badge-inflight { background: rgba(245,158,11,.15); color: var(--warn); }
    .badge-dlq      { background: rgba(255,76,106,.15); color: var(--danger); }
    .badge-ok       { background: rgba(16,185,129,.15); color: var(--ok); }

    .empty { text-align: center; padding: 40px; color: var(--muted); font-size: 13px; }

    /* ── Node info ───────────────────────── */
    .node-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 28px;
    }
    .node-kv {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .node-kv-label { font-size: 11px; color: var(--muted); font-weight: 600; letter-spacing: .05em; text-transform: uppercase; }
    .node-kv-val   { font-size: 13px; font-family: "JetBrains Mono", "Fira Code", monospace; word-break: break-all; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="7" width="20" height="14" rx="2"/>
      <path d="M16 7V5a2 2 0 0 0-4 0v2"/>
      <line x1="12" y1="12" x2="12" y2="16"/>
      <line x1="10" y1="14" x2="14" y2="14"/>
    </svg>
    EpochQ
  </div>
  <span id="statusPill" class="status-pill"><span class="dot"></span><span id="statusText">Connecting…</span></span>
</header>

<main>

  <!-- Summary cards -->
  <div class="cards" id="cards">
    <div class="card">
      <div class="card-label">Total Queues</div>
      <div class="card-value neutral" id="cardQueues">—</div>
    </div>
    <div class="card">
      <div class="card-label">Ready Messages</div>
      <div class="card-value accent" id="cardReady">—</div>
    </div>
    <div class="card">
      <div class="card-label">In-Flight</div>
      <div class="card-value warn" id="cardInflight">—</div>
    </div>
    <div class="card">
      <div class="card-label">DLQ Messages</div>
      <div class="card-value danger" id="cardDlq">—</div>
    </div>
  </div>

  <!-- Queue table -->
  <div class="section-head">
    <h2>Queues</h2>
    <span class="refresh-info" id="lastRefresh">Refreshing every 5 s</span>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Namespace</th>
          <th>Queue</th>
          <th>Ready</th>
          <th>In-Flight</th>
          <th>DLQ Depth</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="queueBody">
        <tr><td colspan="6" class="empty">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Node information -->
  <div class="section-head" style="margin-top:28px">
    <h2>Node</h2>
  </div>
  <div class="node-info" id="nodeInfo">
    <div class="node-kv"><div class="node-kv-label">Node ID</div><div class="node-kv-val" id="nodeId">—</div></div>
    <div class="node-kv"><div class="node-kv-label">Version</div><div class="node-kv-val" id="nodeVersion">—</div></div>
    <div class="node-kv"><div class="node-kv-label">Uptime</div><div class="node-kv-val" id="nodeUptime">—</div></div>
    <div class="node-kv"><div class="node-kv-label">Data Dir</div><div class="node-kv-val" id="nodeDataDir">—</div></div>
  </div>

</main>

<script>
(function () {
  "use strict";

  const $ = id => document.getElementById(id);

  // ── fetch helpers ─────────────────────────────────────────────────────────

  async function apiFetch(path) {
    const res = await fetch(path, { headers: buildHeaders() });
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    return res.json();
  }

  function buildHeaders() {
    // If the server requires an API key the user can set it as a query param
    // ?key=VALUE on the dashboard URL and we'll forward it.
    const params = new URLSearchParams(location.search);
    const key = params.get("key");
    return key ? { "X-Api-Key": key } : {};
  }

  // ── rendering ─────────────────────────────────────────────────────────────

  function updateStatus(ok) {
    const pill = $("statusPill");
    pill.className = "status-pill" + (ok ? "" : " error");
    $("statusText").textContent = ok ? "Online" : "Unreachable";
  }

  function fmt(n) { return (n == null ? "—" : Number(n).toLocaleString()); }

  function renderQueues(queues) {
    const tbody = $("queueBody");
    if (!queues || queues.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="empty">No queues yet.</td></tr>';
      $("cardQueues").textContent  = "0";
      $("cardReady").textContent   = "0";
      $("cardInflight").textContent= "0";
      $("cardDlq").textContent     = "0";
      return;
    }

    let totalReady = 0, totalInflight = 0, totalDlq = 0;
    queues.forEach(q => {
      totalReady    += q.ready    || 0;
      totalInflight += q.in_flight|| 0;
      totalDlq      += q.dlq_depth|| 0;
    });

    $("cardQueues").textContent   = fmt(queues.length);
    $("cardReady").textContent    = fmt(totalReady);
    $("cardInflight").textContent = fmt(totalInflight);
    $("cardDlq").textContent      = fmt(totalDlq);

    tbody.innerHTML = queues.map(q => {
      const dlq   = q.dlq_depth || 0;
      const inflt = q.in_flight || 0;
      let status;
      if (dlq > 0)    status = '<span class="badge badge-dlq">DLQ</span>';
      else if (inflt) status = '<span class="badge badge-inflight">Active</span>';
      else            status = '<span class="badge badge-ok">Idle</span>';

      return `<tr>
        <td>${esc(q.namespace)}</td>
        <td>${esc(q.name)}</td>
        <td><span class="badge badge-ready">${fmt(q.ready)}</span></td>
        <td><span class="badge badge-inflight">${fmt(inflt)}</span></td>
        <td><span class="badge badge-dlq">${fmt(dlq)}</span></td>
        <td>${status}</td>
      </tr>`;
    }).join("");
  }

  function renderHealth(h) {
    $("nodeId").textContent      = h.node_id      || "—";
    $("nodeVersion").textContent = h.version      || "—";
    $("nodeUptime").textContent  = fmtUptime(h.uptime_ms);
    $("nodeDataDir").textContent = h.data_dir     || "—";
  }

  function fmtUptime(ms) {
    if (!ms) return "—";
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return [h && (h + "h"), m && (m + "m"), (sec + "s")].filter(Boolean).join(" ");
  }

  function esc(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  // ── refresh cycle ──────────────────────────────────────────────────────────

  async function refresh() {
    try {
      const [stats, health] = await Promise.all([
        apiFetch("/api/stats"),
        apiFetch("/health"),
      ]);
      updateStatus(true);
      renderQueues(stats);
      renderHealth(health);
      const now = new Date();
      $("lastRefresh").textContent = "Last updated " + now.toLocaleTimeString();
    } catch (err) {
      updateStatus(false);
      console.warn("dashboard fetch error:", err);
    }
  }

  // kick off immediately, then every 5 s
  refresh();
  setInterval(refresh, 5000);
})();
</script>
</body>
</html>
