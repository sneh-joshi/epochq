<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EpochQueue Dashboard</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --border: #2a2d3e;
      --accent: #6c63ff;
      --accent2: #00d9a3;
      --text: #e2e4ef;
      --muted: #6b7280;
      --danger: #ff4c6a;
      --warn: #f59e0b;
      --ok: #10b981;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* â”€â”€ Topbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 17px; }
    .logo svg { flex-shrink: 0; }

    .status-pill {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; border-radius: 999px;
      font-size: 12px; font-weight: 600;
      background: rgba(16,185,129,.15); color: var(--ok);
    }
    .status-pill.error { background: rgba(255,76,106,.15); color: var(--danger); }
    .status-pill .dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: currentColor; animation: pulse 1.6s infinite;
    }
    @keyframes pulse { 0%,100%{ opacity:1 } 50%{ opacity:.4 } }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main { padding: 24px; max-width: 1280px; margin: 0 auto; }

    /* â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 18px 20px;
    }
    .card-label { font-size: 11px; font-weight: 600; letter-spacing: .07em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .card-value { font-size: 28px; font-weight: 700; line-height: 1; }
    .card-value.accent  { color: var(--accent2); }
    .card-value.warn    { color: var(--warn); }
    .card-value.danger  { color: var(--danger); }
    .card-value.neutral { color: var(--text); }

    /* â”€â”€ Section heading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-head {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .section-head h2 { font-size: 15px; font-weight: 600; }
    .refresh-info { font-size: 12px; color: var(--muted); }

    /* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border); }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: var(--surface);
      padding: 10px 14px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .07em;
      text-transform: uppercase;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }
    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .1s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(108,99,255,.06); }
    tbody td { padding: 11px 14px; }

    .badge {
      display: inline-block;
      padding: 2px 8px; border-radius: 999px;
      font-size: 11px; font-weight: 600;
    }
    .badge-ready     { background: rgba(0,217,163,.15); color: var(--accent2); }
    .badge-inflight  { background: rgba(245,158,11,.15); color: var(--warn); }
    .badge-scheduled { background: rgba(139,92,246,.15); color: #a78bfa; }
    .badge-depth     { background: rgba(99,179,237,.15); color: #63b3ed; font-weight:600; }
    .badge-dlq       { background: rgba(255,76,106,.15); color: var(--danger); }
    .badge-ok       { background: rgba(16,185,129,.15); color: var(--ok); }

    .empty { text-align: center; padding: 40px; color: var(--muted); font-size: 13px; }

    .btn-purge {
      padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
      background: rgba(255,76,106,.1); border: 1px solid rgba(255,76,106,.35);
      color: var(--danger); cursor: pointer; white-space: nowrap;
      transition: background .15s, border-color .15s;
    }
    .btn-purge:hover  { background: rgba(255,76,106,.22); border-color: var(--danger); }
    .btn-purge:disabled { opacity: .45; cursor: not-allowed; }

    .btn-delete {
      padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
      background: rgba(255,76,106,.22); border: 1px solid var(--danger);
      color: var(--danger); cursor: pointer; white-space: nowrap;
      transition: background .15s;
    }
    .btn-delete:hover  { background: rgba(255,76,106,.4); }
    .btn-delete:disabled { opacity: .45; cursor: not-allowed; }

    .btn-publish {
      padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
      background: rgba(108,99,255,.15); border: 1px solid rgba(108,99,255,.4);
      color: var(--accent); cursor: pointer; white-space: nowrap;
      transition: background .15s;
    }
    .btn-publish:hover { background: rgba(108,99,255,.28); border-color: var(--accent); }
    .btn-publish:disabled { opacity: .45; cursor: not-allowed; }

    /* â”€â”€ Namespace group row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ns-group-row td {
      background: rgba(108,99,255,.07);
      border-top: 2px solid rgba(108,99,255,.2);
      padding: 7px 14px;
      font-size: 11px; font-weight: 700;
      letter-spacing: .08em; text-transform: uppercase;
      color: var(--accent);
    }

    /* â”€â”€ Card sub-label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card-sub { font-size: 10px; color: var(--muted); margin-bottom: 8px; margin-top: 2px; }

    /* â”€â”€ Node info â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .node-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 28px;
    }
    .node-kv {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      display: flex; flex-direction: column; gap: 4px;
    }
    .node-kv-label { font-size: 11px; color: var(--muted); font-weight: 600; letter-spacing: .05em; text-transform: uppercase; }
    .node-kv-val   { font-size: 13px; font-family: "JetBrains Mono", "Fira Code", monospace; word-break: break-all; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="2" y="7" width="20" height="14" rx="2"/>
      <path d="M16 7V5a2 2 0 0 0-4 0v2"/>
      <line x1="12" y1="12" x2="12" y2="16"/>
      <line x1="10" y1="14" x2="14" y2="14"/>
    </svg>
    EpochQueue
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <a href="/playground" style="font-size:12px;color:var(--accent);text-decoration:none;font-weight:600;border:1px solid var(--accent);padding:4px 10px;border-radius:6px">Playground â†—</a>
    <button id="settingsBtn" title="API Key Settings" style="background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;padding:5px 8px;font-size:13px">âš™ API Key</button>
    <span id="statusPill" class="status-pill"><span class="dot"></span><span id="statusText">Connectingâ€¦</span></span>
  </div>
</header>

<!-- Create Queue modal -->
<div id="createModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:102;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 32px;min-width:380px;max-width:460px;width:90%">
    <h3 style="margin-bottom:6px;font-size:16px">New Queue</h3>
    <p style="font-size:12px;color:var(--muted);margin-bottom:20px">Creates an empty queue. Messages can be published immediately after.</p>
    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Namespace</label>
    <input id="createNs" type="text" placeholder="e.g. payments"
      style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;margin-bottom:14px">
    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Queue Name</label>
    <input id="createName" type="text" placeholder="e.g. orders"
      style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;margin-bottom:20px">
    <div id="createError" style="display:none;font-size:12px;color:var(--danger);margin-bottom:12px"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button id="createCancel" style="padding:8px 18px;background:none;border:1px solid var(--border);border-radius:7px;color:var(--text);cursor:pointer;font-size:13px">Cancel</button>
      <button id="createSubmit" style="padding:8px 18px;background:var(--accent);border:none;border-radius:7px;color:#fff;cursor:pointer;font-size:13px;font-weight:600">Create Queue</button>
    </div>
  </div>
</div>

<!-- Publish Message modal -->
<div id="publishModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:101;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 32px;min-width:400px;max-width:520px;width:90%">
    <h3 style="margin-bottom:4px;font-size:16px">Send Message</h3>
    <p id="publishQueueLabel" style="font-size:12px;color:var(--muted);margin-bottom:18px;font-family:monospace"></p>

    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Body <span style="font-weight:400;text-transform:none">(plain text)</span></label>
    <textarea id="publishBody" rows="4" placeholder="Hello, world!"
      style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;resize:vertical;margin-bottom:14px;font-family:inherit"></textarea>

    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Deliver At <span style="font-weight:400;text-transform:none">(optional â€” leave empty for immediate)</span></label>
    <input id="publishDeliverAt" type="datetime-local"
      style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;margin-bottom:14px">

    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:5px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">Metadata <span style="font-weight:400;text-transform:none">(optional JSON object)</span></label>
    <textarea id="publishMeta" rows="2" placeholder='{"source": "dashboard"}'
      style="width:100%;box-sizing:border-box;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:13px;outline:none;resize:vertical;margin-bottom:20px;font-family:monospace"></textarea>

    <div id="publishError" style="display:none;font-size:12px;color:var(--danger);margin-bottom:12px"></div>

    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button id="publishCancel" style="padding:8px 18px;background:none;border:1px solid var(--border);border-radius:7px;color:var(--text);cursor:pointer;font-size:13px">Cancel</button>
      <button id="publishSend" style="padding:8px 18px;background:var(--accent);border:none;border-radius:7px;color:#fff;cursor:pointer;font-size:13px;font-weight:600">Send â†‘</button>
    </div>
  </div>
</div>

<!-- Settings modal -->
<div id="settingsModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:28px 32px;min-width:360px;max-width:480px;width:90%">
    <h3 style="margin-bottom:16px;font-size:16px">API Key Settings</h3>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">The key is stored only in your browser's <code style="font-family:monospace">localStorage</code> â€” never sent as a URL parameter.</p>
    <label style="display:block;font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">X-Api-Key</label>
    <input id="apiKeyInput" type="password" placeholder="Leave empty if auth is disabled"
      style="width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:14px;outline:none;margin-bottom:20px">
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button id="settingsCancel" style="padding:8px 18px;background:none;border:1px solid var(--border);border-radius:7px;color:var(--text);cursor:pointer;font-size:13px">Cancel</button>
      <button id="settingsSave" style="padding:8px 18px;background:var(--accent);border:none;border-radius:7px;color:#fff;cursor:pointer;font-size:13px;font-weight:600">Save</button>
    </div>
  </div>
</div>

<main>

  <!-- Summary cards -->
  <div class="cards" id="cards">
    <div class="card">
      <div class="card-label">Total Depth</div>
      <div class="card-sub">ready + in-flight + scheduled</div>
      <div class="card-value accent" id="cardDepth">â€”</div>
    </div>
    <div class="card">
      <div class="card-label">Namespaces</div>
      <div class="card-sub">unique active namespaces</div>
      <div class="card-value neutral" id="cardNs">â€”</div>
    </div>
    <div class="card">
      <div class="card-label">Scheduled</div>
      <div class="card-sub">awaiting future delivery</div>
      <div class="card-value" id="cardSched" style="color:#a78bfa">â€”</div>
    </div>
    <div class="card">
      <div class="card-label">DLQ Alerts</div>
      <div class="card-sub">queues with failed messages</div>
      <div class="card-value danger" id="cardDlq">â€”</div>
    </div>
  </div>

  <!-- Queue table -->
  <div class="section-head">
    <h2>Queues</h2>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <button id="createQueueBtn" style="padding:5px 14px;border-radius:7px;background:var(--accent);border:none;color:#fff;cursor:pointer;font-size:12px;font-weight:700;letter-spacing:.02em">+ New Queue</button>
      <div style="display:flex;align-items:center;gap:5px">
        <button id="pgPrev" style="padding:3px 9px;border-radius:5px;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:12px" disabled>â†</button>
        <span id="pgInfo" style="font-size:12px;color:var(--muted);white-space:nowrap">â€”</span>
        <button id="pgNext" style="padding:3px 9px;border-radius:5px;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:12px" disabled>â†’</button>
      </div>
      <span class="refresh-info" id="lastRefresh">Refreshing every 5 s</span>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Queue</th>
          <th>Depth</th>
          <th>Ready</th>
          <th>In-Flight</th>
          <th>Scheduled</th>
          <th>DLQ Depth</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="queueBody">
        <tr><td colspan="8" class="empty">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Node information -->
  <div class="section-head" style="margin-top:28px">
    <h2>Node</h2>
  </div>
  <div class="node-info" id="nodeInfo">
    <div class="node-kv"><div class="node-kv-label">Node ID</div><div class="node-kv-val" id="nodeId">â€”</div></div>
    <div class="node-kv"><div class="node-kv-label">Version</div><div class="node-kv-val" id="nodeVersion">â€”</div></div>
    <div class="node-kv"><div class="node-kv-label">Uptime</div><div class="node-kv-val" id="nodeUptime">â€”</div></div>
    <div class="node-kv"><div class="node-kv-label">Data Dir</div><div class="node-kv-val" id="nodeDataDir">â€”</div></div>
  </div>

</main>

<script>
(function () {
  "use strict";

  const $ = id => document.getElementById(id);

  // â”€â”€ API key (stored in localStorage, never in the URL) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function getApiKey() { return localStorage.getItem("epochqueue_api_key") || ""; }

  function buildHeaders() {
    const key = getApiKey();
    return key ? { "X-Api-Key": key } : {};
  }

  // â”€â”€ Settings modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const modal = $("settingsModal");
  $("settingsBtn").addEventListener("click", () => {
    $("apiKeyInput").value = getApiKey();
    modal.style.display = "flex";
  });
  $("settingsCancel").addEventListener("click", () => { modal.style.display = "none"; });
  $("settingsSave").addEventListener("click", () => {
    const key = $("apiKeyInput").value.trim();
    if (key) localStorage.setItem("epochqueue_api_key", key);
    else localStorage.removeItem("epochqueue_api_key");
    modal.style.display = "none";
  });
  modal.addEventListener("click", e => { if (e.target === modal) modal.style.display = "none"; });
  // â”€â”€ Create Queue modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const createModal = $('createModal');
  $('createQueueBtn').addEventListener('click', () => {
    $('createNs').value = '';
    $('createName').value = '';
    $('createError').style.display = 'none';
    $('createSubmit').disabled = false;
    $('createSubmit').textContent = 'Create Queue';
    $('createSubmit').style.background = '';
    createModal.style.display = 'flex';
    setTimeout(() => $('createNs').focus(), 60);
  });
  $('createCancel').addEventListener('click', () => { createModal.style.display = 'none'; });
  createModal.addEventListener('click', e => { if (e.target === createModal) createModal.style.display = 'none'; });
  ['createNs','createName'].forEach(id => {
    $(id).addEventListener('keydown', e => { if (e.key === 'Enter') $('createSubmit').click(); });
    $(id).addEventListener('input', e => { e.target.value = e.target.value.toLowerCase(); });
  });
  $('createSubmit').addEventListener('click', async () => {
    const ns   = $('createNs').value.trim().toLowerCase();
    const name = $('createName').value.trim().toLowerCase();
    if (!ns || !name) {
      $('createError').textContent = 'Namespace and queue name are required.';
      $('createError').style.display = 'block';
      return;
    }
    $('createSubmit').disabled = true;
    $('createSubmit').textContent = 'Creatingâ€¦';
    $('createError').style.display = 'none';
    try {
      await apiFetch(`/namespaces/${encodeURIComponent(ns)}/queues/${encodeURIComponent(name)}`, 'POST', {});
      $('createSubmit').textContent = 'âœ“ Created';
      $('createSubmit').style.background = 'var(--ok)';
      setTimeout(() => {
        createModal.style.display = 'none';
        $('createSubmit').disabled = false;
        $('createSubmit').textContent = 'Create Queue';
        $('createSubmit').style.background = '';
        refresh();
      }, 900);
    } catch (err) {
      $('createError').textContent = 'Error: ' + err.message;
      $('createError').style.display = 'block';
      $('createSubmit').disabled = false;
      $('createSubmit').textContent = 'Create Queue';
    }
  });
  // â”€â”€ Publish modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let _publishNs = '', _publishName = '';
  const pubModal = $('publishModal');

  function publishToQueue(ns, name) {
    _publishNs   = ns;
    _publishName = name;
    $('publishQueueLabel').textContent = ns + ' / ' + name;
    $('publishBody').value = '';
    $('publishDeliverAt').value = '';
    $('publishMeta').value = '';
    $('publishError').style.display = 'none';
    $('publishSend').disabled = false;
    $('publishSend').textContent = 'Send â†‘';
    pubModal.style.display = 'flex';
    setTimeout(() => $('publishBody').focus(), 60);
  }

  $('publishCancel').addEventListener('click', () => { pubModal.style.display = 'none'; });
  pubModal.addEventListener('click', e => { if (e.target === pubModal) pubModal.style.display = 'none'; });

  $('publishSend').addEventListener('click', async () => {
    const body = $('publishBody').value;
    if (!body.trim()) {
      $('publishError').textContent = 'Body is required.';
      $('publishError').style.display = 'block';
      return;
    }
    const dtVal = $('publishDeliverAt').value;
    const metaRaw = $('publishMeta').value.trim();
    let metadata;
    if (metaRaw) {
      try { metadata = JSON.parse(metaRaw); }
      catch {
        $('publishError').textContent = 'Metadata is not valid JSON.';
        $('publishError').style.display = 'block';
        return;
      }
    }
    const payload = {
      body: btoa(unescape(encodeURIComponent(body))), // UTF-8 â†’ base64
    };
    if (dtVal) payload.deliver_at = new Date(dtVal).getTime();
    if (metadata) payload.metadata = metadata;

    $('publishSend').disabled = true;
    $('publishSend').textContent = 'Sendingâ€¦';
    $('publishError').style.display = 'none';
    try {
      const res = await apiFetch(
        `/namespaces/${encodeURIComponent(_publishNs)}/queues/${encodeURIComponent(_publishName)}/messages`,
        'POST', payload
      );
      $('publishSend').textContent = 'âœ“ Sent' + (res && res.id ? ' (' + res.id.slice(-6) + ')' : '');
      $('publishSend').style.background = 'var(--ok)';
      setTimeout(() => {
        pubModal.style.display = 'none';
        $('publishSend').disabled = false;
        $('publishSend').textContent = 'Send â†‘';
        $('publishSend').style.background = '';
        refresh();
      }, 1200);
    } catch (err) {
      $('publishError').textContent = 'Error: ' + err.message;
      $('publishError').style.display = 'block';
      $('publishSend').disabled = false;
      $('publishSend').textContent = 'Send â†‘';
    }
  });

  // expose for inline onclick
  window._publish = publishToQueue;
  // â”€â”€ fetch helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function apiFetch(path, method = "GET", body) {
    const opts = { method, headers: buildHeaders() };
    if (body !== undefined) {
      opts.headers["Content-Type"] = "application/json";
      opts.body = JSON.stringify(body);
    }
    const res = await fetch(path, opts);
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    if (res.status === 204 || res.headers.get("content-length") === "0") return null;
    return res.json();
  }

  async function deleteQueue(ns, name, btn) {
    if (!confirm(`Delete queue ${ns}/${name}?\n\nThis permanently removes the queue, all its messages, and its DLQ. This cannot be undone.`)) return;
    btn.disabled = true;
    btn.textContent = "Deletingâ€¦";
    try {
      await apiFetch(`/namespaces/${encodeURIComponent(ns)}/queues/${encodeURIComponent(name)}`, "DELETE");
      // Remove the row immediately â€” queue no longer exists.
      const row = btn.closest("tr");
      if (row) row.remove();
      // Refresh to update summary cards.
      refresh();
    } catch (err) {
      btn.textContent = "Error";
      btn.style.color = "var(--danger)";
      setTimeout(() => { btn.disabled = false; btn.textContent = "âœ• Delete"; btn.style.cssText = ""; }, 2200);
      console.error("delete queue error:", err);
    }
  }

  async function purgeQueue(ns, name, btn) {
    if (!confirm(`Purge ALL messages from ${ns}/${name}?\n\nThis removes every READY and IN_FLIGHT message immediately and cannot be undone.`)) return;
    btn.disabled = true;
    btn.textContent = "Purgingâ€¦";
    try {
      const data = await apiFetch(`/namespaces/${encodeURIComponent(ns)}/queues/${encodeURIComponent(name)}/messages`, "DELETE");
      const n = data ? (data.purged ?? 0) : 0;
      btn.textContent = `âœ“ Purged (${n})`;
      btn.style.color = "var(--ok)";
      btn.style.borderColor = "var(--ok)";
      btn.style.background = "rgba(16,185,129,.1)";
      setTimeout(() => { btn.disabled = false; btn.textContent = "ğŸ—‘ Purge"; btn.style.cssText = ""; refresh(); }, 2200);
    } catch (err) {
      btn.textContent = "Error";
      btn.style.color = "var(--danger)";
      setTimeout(() => { btn.disabled = false; btn.textContent = "ğŸ—‘ Purge"; btn.style.cssText = ""; }, 2200);
      console.error("purge error:", err);
    }
  }

  // â”€â”€ rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function updateStatus(ok) {
    const pill = $("statusPill");
    pill.className = "status-pill" + (ok ? "" : " error");
    $("statusText").textContent = ok ? "Online" : "Unreachable";
  }

  function fmt(n) { return (n == null ? "â€”" : Number(n).toLocaleString()); }

  // â”€â”€ Summary cards (fed from /api/stats/summary) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function renderSummary(s) {
    if (!s) return;
    $("cardDepth").textContent = fmt(s.total_depth);
    $("cardNs").textContent    = fmt(s.namespaces);
    $("cardSched").textContent = fmt(s.total_scheduled);
    $("cardDlq").textContent   = fmt(s.dlq_alerts);
  }

  // â”€â”€ Pagination state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let _statsPage = 1;
  const _statsLimit = 50;
  let _statsTotalPages = 1;

  $("pgPrev").addEventListener("click", () => {
    if (_statsPage > 1) { _statsPage--; refreshTable(); }
  });
  $("pgNext").addEventListener("click", () => {
    if (_statsPage < _statsTotalPages) { _statsPage++; refreshTable(); }
  });

  function renderQueues(data) {
    const queues = data ? (data.queues || []) : [];
    _statsTotalPages = data ? (data.total_pages || 1) : 1;
    const total = data ? (data.total || 0) : 0;

    // Pagination controls
    $("pgInfo").textContent = `Page ${_statsPage}Â /Â ${_statsTotalPages} Â· ${total} queue${total !== 1 ? 's' : ''}`;
    $("pgPrev").disabled = _statsPage <= 1;
    $("pgNext").disabled = _statsPage >= _statsTotalPages;

    const tbody = $("queueBody");
    if (!queues || queues.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="empty">No queues yet. Use "+ New Queue" to create one.</td></tr>';
      return;
    }

    // Group by namespace (server already sorts ns/name)
    const groups = {};
    queues.forEach(q => { (groups[q.namespace] = groups[q.namespace] || []).push(q); });

    let html = '';
    Object.keys(groups).sort().forEach(ns => {
      const count = groups[ns].length;
      html += `<tr class="ns-group-row"><td colspan="8">ğŸ“ ${esc(ns)}<span style="font-weight:400;color:var(--muted);margin-left:8px">${count} queue${count !== 1 ? 's' : ''}</span></td></tr>`;
      groups[ns].forEach(q => {
        const dlq   = q.dlq_depth || 0;
        const inflt = q.in_flight || 0;
        const sched = q.scheduled || 0;
        const depth = q.depth != null ? q.depth : ((q.ready || 0) + inflt + sched);
        let status;
        if (dlq > 0)        status = '<span class="badge badge-dlq">DLQ</span>';
        else if (sched > 0) status = '<span class="badge badge-scheduled">Scheduled</span>';
        else if (inflt)     status = '<span class="badge badge-inflight">Active</span>';
        else                status = '<span class="badge badge-ok">Idle</span>';
        const purgeId  = `purge-${esc(q.namespace)}-${esc(q.name)}`;
        const deleteId = `del-${esc(q.namespace)}-${esc(q.name)}`;
        html += `<tr>
          <td>${esc(q.name)}</td>
          <td><span class="badge badge-depth">${fmt(depth)}</span></td>
          <td><span class="badge badge-ready">${fmt(q.ready)}</span></td>
          <td><span class="badge badge-inflight">${fmt(inflt)}</span></td>
          <td><span class="badge badge-scheduled">${fmt(sched)}</span></td>
          <td><span class="badge badge-dlq">${fmt(dlq)}</span></td>
          <td>${status}</td>
          <td style="white-space:nowrap">
            <button class="btn-publish" onclick="window._publish('${esc(q.namespace)}','${esc(q.name)}')">â†‘ Send</button>
            <button class="btn-purge" id="${purgeId}" onclick="window._purge('${esc(q.namespace)}','${esc(q.name)}',this)" style="margin-left:6px">ğŸ—‘ Purge</button>
            <button class="btn-delete" id="${deleteId}" onclick="window._delete('${esc(q.namespace)}','${esc(q.name)}',this)" style="margin-left:6px">âœ• Delete</button>
          </td>
        </tr>`;
      });
    });
    tbody.innerHTML = html;
    window._purge  = purgeQueue;
    window._delete = deleteQueue;
  }

  function renderHealth(h) {
    $("nodeId").textContent      = h.node_id      || "â€”";
    $("nodeVersion").textContent = h.version      || "â€”";
    $("nodeUptime").textContent  = fmtUptime(h.uptime_ms);
    $("nodeDataDir").textContent = h.data_dir     || "â€”";
  }

  function fmtUptime(ms) {
    if (!ms) return "â€”";
    const s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60), sec = s % 60;
    return [h && (h + "h"), m && (m + "m"), (sec + "s")].filter(Boolean).join(" ");
  }

  function esc(s) {
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  // â”€â”€ refresh cycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function refresh() {
    try {
      const [summary, page, health] = await Promise.all([
        apiFetch("/api/stats/summary"),
        apiFetch(`/api/stats?page=${_statsPage}&limit=${_statsLimit}`),
        apiFetch("/health"),
      ]);
      updateStatus(true);
      renderSummary(summary);
      renderQueues(page);
      renderHealth(health);
      const now = new Date();
      $("lastRefresh").textContent = "Last updated " + now.toLocaleTimeString();
    } catch (err) {
      updateStatus(false);
      console.warn("dashboard fetch error:", err);
    }
  }

  async function refreshTable() {
    try {
      const page = await apiFetch(`/api/stats?page=${_statsPage}&limit=${_statsLimit}`);
      renderQueues(page);
    } catch (err) {
      console.warn("table fetch error:", err);
    }
  }

  // kick off immediately, then every 5 s
  refresh();
  setInterval(refresh, 5000);
})();
</script>
</body>
</html>
